#!/usr/bin/env python

import sys
import re
import requests
from bs4 import BeautifulSoup
import clint
from clint.textui import puts, indent

def stalkernet(query):
    r = requests.get('https://apps.carleton.edu/search/', params={'keyword': query})

    if not r:
        print >> sys.stderr, query, 'not found. :('
        return None

    soup = BeautifulSoup(r.content)
    people = soup.find_all('ul', {'class': 'person'})

    if not people:
        print >> sys.stderr, query, 'not found. :('
        return None

    results = []
    for person in people:
        result = {}
        # print person.prettify()
        try:
            name, year = person.find('li', 'person_name').text.split(',')
            result['year'] = year.strip()
        except ValueError:
            name = person.find('li', 'person_name').text
        finally:
            result['name'] = name.strip()

        result['title'] = person.find('li', 'person_title').get_text().strip()
        try:
            phone, email = person.find('li', 'person_contact').text.split(u'\u2022')
            result['email'] = email.strip()
        except ValueError:
            phone = person.find('li', 'person_contact').text
        finally:
            result['phone'] = phone.strip()

            address_html_ = person.find('div', {'id': re.compile(r'\w+_more')}).find('ul').find_all('li')
            address_html = []
            for a in address_html_:
                if a.get('class'):
                    break
                address_html.append(a)
            address = []
            for a in address_html:
                address.append('\n'.join([i for i in a.contents if isinstance(i, basestring)]))
            result['address'] = '\n'.join(address)


        results.append(result)

    return results

def print_results(results):
    if not results:
        return

    for person in results:
        if person.get('year'):
            puts(person['name'] + ', ' + person['year'])
        else:
            puts(person['name'])

        with indent(4):
            puts(person['title'])
            puts(person['phone'])
            if person.get('email'):
                puts(person['email'])
            puts(person['address'])

if __name__ == '__main__':
    query = ' '.join(clint.args.all)

    if query:
        print_results(stalkernet(query))
    else:
        print >> sys.stderr, 'USAGE: stalkernet <query>'
